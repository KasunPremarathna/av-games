<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Crash Betting Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; }
        canvas { max-width: 100%; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-4">Crash Betting Game</h1>
        <div id="userInfo" class="mb-4"></div>
        <div class="flex flex-col md:flex-row gap-4">
            <div class="bg-white p-6 rounded-lg shadow-md md:w-1/2">
                <h2 class="text-xl font-bold mb-4">Place Bet</h2>
                <input type="number" id="betAmount" placeholder="Bet Amount" min="1" class="border p-2 rounded w-full mb-4">
                <button onclick="placeBet()" class="bg-blue-500 text-white p-2 rounded w-full hover:bg-blue-600">Place Bet</button>
                <button onclick="cashout()" id="cashoutBtn" disabled class="bg-green-500 text-white p-2 rounded w-full mt-2 hover:bg-green-600">Cash Out</button>
                <div id="multiplier" class="text-2xl font-bold text-green-600 mt-4">Multiplier: 1.00x</div>
                <div id="status" class="text-red-500 mt-2"></div>
                <canvas id="multiplierChart" class="mt-4"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md md:w-1/2">
                <h2 class="text-xl font-bold mb-4">User Panel</h2>
                <p id="balance" class="mb-4"></p>
                <input type="number" id="topupAmount" placeholder="Top-up Amount" min="1" class="border p-2 rounded w-full mb-4">
                <button onclick="requestTopup()" class="bg-blue-500 text-white p-2 rounded w-full hover:bg-blue-600">Request Top-up</button>
                <h3 class="text-lg font-bold mt-4">Game History</h3>
                <ul id="historyList" class="list-disc pl-5"></ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let userId = localStorage.getItem('userId');
        let gameId = null;
        let betId = null;
        let multiplier = 1.0;
        let gameRunning = false;
        let animationFrame;

        const ctx = document.getElementById('multiplierChart').getContext('2d');
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Multiplier',
                    data: [],
                    borderColor: '#16a34a',
                    fill: false
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });

        async function fetchUser() {
            if (!userId) {
                document.getElementById('userInfo').innerHTML = 'Please <a href="register.html" class="text-blue-500">register</a> or <a href="login.html" class="text-blue-500">login</a>.';
                document.getElementById('status').textContent = 'User not logged in.';
                return;
            }
            const response = await fetch(`api.php?action=get_user&user_id=${userId}`);
            const user = await response.json();
            if (user.error) {
                document.getElementById('userInfo').innerHTML = 'User not found. Please <a href="register.html" class="text-blue-500">register</a>.';
            } else {
                document.getElementById('userInfo').innerHTML = `User: ${user.username}, Balance: $${user.balance.toFixed(2)} <a href="register.html" class="text-blue-500">Logout</a>`;
                document.getElementById('balance').textContent = `Current Balance: $${user.balance.toFixed(2)}`;
            }
        }

        async function fetchHistory() {
            if (!userId) return;
            const response = await fetch(`api.php?action=get_history&user_id=${userId}`);
            const history = await response.json();
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            history.forEach(bet => {
                const li = document.createElement('li');
                li.textContent = `Game ${bet.game_id}: Bet $${bet.bet_amount}, ` +
                    (bet.cashout_status === 'approved' ? 
                        `Cashed out at ${bet.cashout_multiplier}x, Won $${bet.win_amount}` :
                        bet.cashout_status === 'pending' ? 
                        `Pending cashout at ${bet.cashout_multiplier}x` :
                        `Crashed at ${bet.crash_point}x, ${bet.cashout_status === 'rejected' ? 'Cashout rejected' : 'Lost'}`);
                historyList.appendChild(li);
            });
        }

        async function placeBet() {
            if (!userId) {
                document.getElementById('status').textContent = 'Please register or login.';
                return;
            }
            const betAmount = parseFloat(document.getElementById('betAmount').value);
            if (isNaN(betAmount) || betAmount <= 0) {
                document.getElementById('status').textContent = 'Enter a valid bet amount';
                return;
            }

            const gameResponse = await fetch('api.php?action=set_crash_point', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ admin_id: 1, crash_point: 0 }) // Admin sets crash point later
            });
            const gameData = await gameResponse.json();
            if (gameData.error) {
                document.getElementById('status').textContent = gameData.error;
                return;
            }
            gameId = gameData.game_id;

            const betResponse = await fetch('api.php?action=place_bet', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, bet_amount: betAmount, game_id: gameId })
            });
            const betData = await betResponse.json();
            if (betData.error) {
                document.getElementById('status').textContent = betData.error;
                return;
            }

            betId = betData.bet_id;
            gameRunning = true;
            document.getElementById('cashoutBtn').disabled = false;
            document.getElementById('status').textContent = 'Bet placed! Game started!';
            startMultiplier();
        }

        async function cashout() {
            if (!gameRunning || !betId) return;
            gameRunning = false;
            cancelAnimationFrame(animationFrame);

            const response = await fetch('api.php?action=cashout', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ bet_id: betId, multiplier: multiplier.toFixed(2), game_id: gameId })
            });
            const data = await response.json();
            document.getElementById('status').textContent = data.error || 'Cashout request submitted. Waiting for admin approval.';
            document.getElementById('cashoutBtn').disabled = true;
            fetchUser();
            fetchHistory();
        }

        async function requestTopup() {
            if (!userId) {
                document.getElementById('status').textContent = 'Please register or login.';
                return;
            }
            const amount = parseFloat(document.getElementById('topupAmount').value);
            if (isNaN(amount) || amount <= 0) {
                document.getElementById('status').textContent = 'Enter a valid top-up amount';
                return;
            }

            const response = await fetch('api.php?action=topup_request', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ user_id: userId, amount })
            });
            const data = await response.json();
            document.getElementById('status').textContent = data.error || 'Top-up request submitted.';
            document.getElementById('topupAmount').value = '';
        }

        function startMultiplier() {
            multiplier = 1.0;
            const startTime = Date.now();
            chart.data.labels = [];
            chart.data.datasets[0].data = [];
            async function updateMultiplier() {
                if (!gameRunning) return;
                const elapsed = (Date.now() - startTime) / 1000;
                multiplier = 1 + elapsed * 0.5;
                document.getElementById('multiplier').textContent = `Multiplier: ${multiplier.toFixed(2)}x`;
                chart.data.labels.push(elapsed.toFixed(1));
                chart.data.datasets[0].data.push(multiplier.toFixed(2));
                chart.update();

                const response = await fetch(`api.php?action=set_crash_point&game_id=${gameId}`);
                const gameData = await response.json();
                if (gameData.error || multiplier >= gameData.crash_point) {
                    gameRunning = false;
                    cancelAnimationFrame(animationFrame);
                    document.getElementById('status').textContent = gameData.error || 
                        `Crashed at ${gameData.crash_point}x! You lost.`;
                    document.getElementById('cashoutBtn').disabled = true;
                    fetchUser();
                    fetchHistory();
                } else {
                    animationFrame = requestAnimationFrame(updateMultiplier);
                }
            }
            animationFrame = requestAnimationFrame(updateMultiplier);
        }

        // Initialize
        fetchUser();
        fetchHistory();
    </script>
</body>
</html>