<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Aviator Paper Bet - Login</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container mx-auto p-4 max-w-md">
        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">Aviator Paper Bet - Login</h1>
        <div class="bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-bold mb-4 text-gray-700">Login</h2>
            <div class="mb-4">
                <label for="username" class="block mb-2 font-medium">Username:</label>
                <input type="text" id="username" placeholder="Enter username" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-4">
                <label for="password" class="block mb-2 font-medium">Password:</label>
                <input type="password" id="password" placeholder="Enter password" class="border p-2 rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <button onclick="login()" id="loginBtn" class="bg-blue-500 text-white p-2 rounded w-full hover:bg-blue-600 transition disabled:bg-gray-400">Login</button>
            <div class="mt-4 text-center">
                <p>Not registered? <a href="register.html" class="text-blue-500 hover:underline">Register here</a></p>
            </div>
            <div id="status" class="mt-4 text-center text-red-500"></div>
        </div>
    </div>

    <script>
        async function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const status = document.getElementById('status');
            const loginBtn = document.getElementById('loginBtn');

            if (!username || !password) {
                status.textContent = 'Please enter both username and password';
                return;
            }

            loginBtn.disabled = true;
            status.textContent = 'Logging in...';

            try {
                const response = await fetch('api.php?action=login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const responseText = await response.text();
                console.log('login:', responseText, 'Status:', response.status);
                const data = JSON.parse(responseText);

                if (data.error) {
                    status.textContent = data.error;
                    loginBtn.disabled = false;
                    return;
                }

                const userId = data.user_id;
                localStorage.setItem('userId', userId);

                // Check if user is admin
                const userResponse = await fetch(`api.php?action=get_user&user_id=${userId}`);
                const userResponseText = await userResponse.text();
                console.log('get_user:', userResponseText, 'Status:', userResponse.status);
                const user = JSON.parse(userResponseText);

                if (user.error) {
                    status.textContent = 'Error fetching user data';
                    localStorage.removeItem('userId');
                    loginBtn.disabled = false;
                    return;
                }

                status.textContent = 'Login successful. Redirecting...';
                setTimeout(() => {
                    window.location.href = user.is_admin ? 'admin.html' : 'index.html';
                }, 1000);
            } catch (error) {
                console.error('login error:', error.message);
                status.textContent = `Error: ${error.message}`;
                loginBtn.disabled = false;
            }
        }

        // Check if already logged in
        if (localStorage.getItem('userId')) {
            document.getElementById('status').textContent = 'Already logged in. Redirecting...';
            setTimeout(() => {
                fetch(`api.php?action=get_user&user_id=${localStorage.getItem('userId')}`)
                    .then(response => response.json())
                    .then(user => {
                        if (!user.error && user.is_admin) {
                            window.location.href = 'admin.html';
                        } else if (!user.error) {
                            window.location.href = 'index.html';
                        } else {
                            localStorage.removeItem('userId');
                            document.getElementById('status').textContent = 'Session expired. Please login.';
                        }
                    })
                    .catch(() => {
                        localStorage.removeItem('userId');
                        document.getElementById('status').textContent = 'Session expired. Please login.';
                    });
            }, 1000);
        }
    </script>
</body>
</html>