<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Admin Login - Crash Betting Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: Arial, sans-serif; }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-4">Crash Betting Game - Admin Panel</h1>
        
        <!-- Login Form -->
        <div id="loginForm" class="bg-white p-6 rounded-lg shadow-md max-w-md mx-auto">
            <h2 class="text-xl font-bold mb-4">Admin Login</h2>
            <div class="mb-4">
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <input type="text" id="username" placeholder="Username" class="border p-2 rounded w-full">
            </div>
            <div class="mb-4">
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" placeholder="Password" class="border p-2 rounded w-full">
            </div>
            <button onclick="adminLogin()" class="bg-blue-500 text-white p-2 rounded w-full hover:bg-blue-600">Login</button>
            <div id="status" class="text-red-500 mt-2"></div>
        </div>

        <!-- Admin Dashboard (Hidden until login) -->
        <div id="dashboard" class="hidden bg-white p-6 rounded-lg shadow-md max-w-2xl mx-auto mt-4">
            <h2 class="text-xl font-bold mb-4">Admin Dashboard</h2>
            <p id="adminInfo" class="mb-4"></p>
            <h3 class="text-lg font-bold mb-2">Pending Transactions</h3>
            <ul id="pendingList" class="list-disc pl-5 mb-4"></ul>
            <button onclick="logout()" class="bg-red-500 text-white p-2 rounded w-full hover:bg-red-600">Logout</button>
        </div>
    </div>

    <script>
        let adminId = localStorage.getItem('adminId');

        async function adminLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const status = document.getElementById('status');

            if (!username || !password) {
                status.textContent = 'Please enter username and password';
                return;
            }

            try {
                console.log('Sending admin login request:', { username });
                const response = await fetch('api.php?action=admin_login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const responseText = await response.text();
                console.log('adminLogin raw response:', responseText, 'HTTP Status:', response.status);
                const data = JSON.parse(responseText);

                if (data.error) {
                    status.textContent = data.error;
                    console.log('Admin login failed:', data.error);
                    return;
                }

                adminId = data.admin_id;
                localStorage.setItem('adminId', adminId);
                status.textContent = 'Login successful! Loading dashboard...';
                console.log('Admin login successful: admin_id=', adminId);
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('adminInfo').textContent = `Logged in as ${username}`;
                fetchPendingTransactions();
            } catch (error) {
                console.error('adminLogin error:', error.message);
                status.textContent = 'Error logging in: ' + error.message;
            }
        }

        async function fetchPendingTransactions() {
            try {
                const response = await fetch('api.php?action=get_pending_transactions');
                const responseText = await response.text();
                console.log('fetchPendingTransactions raw response:', responseText, 'HTTP Status:', response.status);
                const transactions = JSON.parse(responseText);

                if (transactions.error) {
                    document.getElementById('status').textContent = transactions.error;
                    return;
                }

                const pendingList = document.getElementById('pendingList');
                pendingList.innerHTML = '';
                if (Array.isArray(transactions) && transactions.length > 0) {
                    transactions.forEach(tx => {
                        const li = document.createElement('li');
                        li.textContent = `${tx.username} (${tx.type}): $${parseFloat(tx.amount).toFixed(2)}`;
                        const approveBtn = document.createElement('button');
                        approveBtn.textContent = 'Approve';
                        approveBtn.className = 'ml-2 bg-green-500 text-white p-1 rounded hover:bg-green-600';
                        approveBtn.onclick = () => approveTransaction(tx.id);
                        const rejectBtn = document.createElement('button');
                        rejectBtn.textContent = 'Reject';
                        rejectBtn.className = 'ml-2 bg-red-500 text-white p-1 rounded hover:bg-red-600';
                        rejectBtn.onclick = () => rejectTransaction(tx.id);
                        li.appendChild(approveBtn);
                        li.appendChild(rejectBtn);
                        pendingList.appendChild(li);
                    });
                } else {
                    pendingList.innerHTML = '<li>No pending transactions</li>';
                }
            } catch (error) {
                console.error('fetchPendingTransactions error:', error.message);
                document.getElementById('status').textContent = 'Error fetching transactions: ' + error.message;
            }
        }

        async function approveTransaction(requestId) {
            try {
                const response = await fetch('api.php?action=approve_transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId })
                });
                const responseText = await response.text();
                console.log('approveTransaction raw response:', responseText, 'HTTP Status:', response.status);
                const data = JSON.parse(responseText);

                document.getElementById('status').textContent = data.error || data.message;
                fetchPendingTransactions();
            } catch (error) {
                console.error('approveTransaction error:', error.message);
                document.getElementById('status').textContent = 'Error approving transaction: ' + error.message;
            }
        }

        async function rejectTransaction(requestId) {
            try {
                const response = await fetch('api.php?action=reject_transaction', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ request_id: requestId })
                });
                const responseText = await response.text();
                console.log('rejectTransaction raw response:', responseText, 'HTTP Status:', response.status);
                const data = JSON.parse(responseText);

                document.getElementById('status').textContent = data.error || data.message;
                fetchPendingTransactions();
            } catch (error) {
                console.error('rejectTransaction error:', error.message);
                document.getElementById('status').textContent = 'Error rejecting transaction: ' + error.message;
            }
        }

        function logout() {
            console.log('Logging out admin:', adminId);
            localStorage.removeItem('adminId');
            adminId = null;
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('status').textContent = 'Logged out successfully.';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            document.getElementById('pendingList').innerHTML = '';
        }

        // Initialize
        if (adminId) {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('dashboard').classList.remove('hidden');
            document.getElementById('adminInfo').textContent = 'Logged in as admin';
            fetchPendingTransactions();
        }
    </script>
</body>
</html>